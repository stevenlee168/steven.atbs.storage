<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Admin Confirm - Consumables</title>

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding-top: 80px;
                background-color: #f4f4f4;
                text-align: center;
            }

            /* ===== BANNER ===== */
            .banner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: #4273c3;
                color: white;
                font-size: 20px;
                font-weight: bold;
                padding: 15px 20px;
                z-index: 1000;
                border-bottom-left-radius: 20px;
                border-bottom-right-radius: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                text-align: left;
            }

            .credit {
                font-size: 12px;
                color: #ddd;
                margin-top: 5px;
            }

            h2 {
                margin-bottom: 25px;
                color: #333;
            }

            /* ===== TABLE ===== */
            .table-container {
                max-width: 1100px;
                margin: auto;
                background: white;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }

            th,
            td {
                padding: 10px;
                border-bottom: 1px solid #ddd;
                font-size: 14px;
            }

            th {
                background-color: #f0f4ff;
                white-space: nowrap;
            }

            tr:hover {
                background-color: #f9f9f9;
            }

            th:nth-child(1),td:nth-child(1) {width: 15%;}
            th:nth-child(2),td:nth-child(2) {width: 25%;}
            th:nth-child(3),td:nth-child(3) {width: 10%;text-align: center;}
            th:nth-child(4),td:nth-child(4) {width: 10%;}
            th:nth-child(5),td:nth-child(5) {width: 10%;}
            th:nth-child(6),td:nth-child(6) {width: 10%;}
            th:nth-child(7),td:nth-child(7) {width: 20%;text-align: center;}

            button {
                padding: 8px 14px;
                border-radius: 18px;
                border: 2px solid #007bff;
                background: white;
                cursor: pointer;
                font-weight: bold;
                margin: 2px;
            }

            button:hover {
                background: #007bff;
                color: white;
            }

            /* ===== ACTION BUTTON COLORS ===== */
            .btn-approve {
                border-color: #28a745;
                color: #28a745;
            }

            .btn-approve:hover {
                background: #28a745;
                color: white;
            }

            .btn-reject {
                border-color: #b02a37;
                color: #b02a37;
            }

            .btn-reject:hover {
                background: #b02a37;
                color: white;
            }


            /* ===== LANGUAGE SWITCH ===== */
            .lang-switch {
                position: fixed;
                top: 15px;
                right: 20px;
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 2000;
                font-weight: bold;
                color: white;
            }

            .switch {
                position: relative;
                display: block;
                width: 46px;
                height: 24px;
                flex-shrink: 0;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                inset: 0;
                background-color: #ccc;
                border-radius: 34px;
                transition: 0.3s;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                border-radius: 50%;
                transition: 0.3s;
            }

            input:checked + .slider {
                background-color: #007bff;
            }

            input:checked + .slider:before {
                transform: translateX(22px);
            }

            .filter-bar {
                display: flex;
                gap: 12px;
                margin-bottom: 15px;
            }

            .filter-bar input {
                flex: 1;
                padding: 8px 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 14px;
            }

            .actions {
                text-align: center;
                margin-top: 20px;
            }

            /* ===== MOBILE ===== */
            @media (max-width: 480px) {
                body {
                    padding-top: 70px;
                }

                .banner {
                    font-size: 16px;
                    padding: 10px 15px;
                    border-radius: 0;
                }

                .controls {
                    flex-direction: column;
                    align-items: center;
                    gap: 30px;
                }

                button,
                .placeholder {
                    width: 90%;
                    max-width: 320px;
                }
            }
        </style>
    </head>

    <body>
        <!-- ===== BANNER ===== -->
        <div class="banner">
            Inventory Management System
            <div class="credit">
                &copy; Steven Lee - Email: leechunju1608@gmail.com
            </div>

            <div class="lang-switch">
                <span>EN</span>
                <label class="switch">
                    <input type="checkbox" id="langToggle" />
                    <span class="slider"></span>
                </label>
                <span>ä¸­</span>
            </div>
        </div>

        <h2>Admin Confirm â€“ Pending Consumables</h2>

        <div class="table-container">
            <div class="filter-bar">
                <input type="text" id="filterCode" data-i18n-placeholder="th_code"> 
                <input type="text" id="filterName" data-i18n-placeholder="th_name">
                <input type="text" id="filterBy" data-i18n-placeholder="th_by">
            </div>

            <table>
                <thead>
                    <tr>
                        <th data-i18n="th_code"></th>
                        <th data-i18n="th_name"></th>
                        <th data-i18n="th_qty"></th>
                        <th data-i18n="th_date"></th>
                        <th data-i18n="th_by"></th>
                        <th data-i18n="th_location"></th>
                        <th data-i18n="th_action"></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="pagination" style="margin-top:15px;text-align:center;">
            <button onclick="prevPage()">â—€ Prev</button>
            <span id="pageInfo" style="margin:0 10px;"></span>
            <button onclick="nextPage()">Next â–¶</button>
        </div>


        <div class="actions">
            <button onclick="logout()" data-i18n="logout_btn"></button>
            <button onclick="location.href='index_admin.html'" data-i18n="back_btn"></button>
        </div>


        <script type="module">
            /* ===== FIREBASE ===== */
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
            import {
                getFirestore,
                collection,
                getDocs,
                query,
                where,
                doc,
                updateDoc,
                deleteDoc,
                addDoc
            } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyA7zpEseZx9x_hiPcRHtp4h-All7CL-Dog",
                authDomain: "atbs-inventory.firebaseapp.com",
                projectId: "atbs-inventory",
                storageBucket: "atbs-inventory.firebasestorage.app",
                messagingSenderId: "196392830940",
                appId: "1:196392830940:web:e49a096fb56ac6a58cf119"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const tableBody = document.getElementById("tableBody");
            const filterCode = document.getElementById("filterCode");
            const filterName = document.getElementById("filterName");
            const filterBy   = document.getElementById("filterBy");

            let allData = [];
            let currentPage = 1;
            const PAGE_SIZE = 7;
                        
            window.login = async function () {
                const user = document.getElementById("loginUser").value.trim();
                const pass = document.getElementById("loginPass").value.trim();

                if (!user || !pass) {
                    alert("Please enter username & password");
                    return;
                }

                const q = query(
                    collection(db, "admins"),
                    where("username", "==", user),
                    where("password", "==", pass)
                );

                const snap = await getDocs(q);

                if (snap.empty) {
                    alert("âŒ Invalid login");
                    return;
                }

                const admin = snap.docs[0].data();

                // âœ… lÆ°u session
                localStorage.setItem("adminLogin", admin.username);
                localStorage.setItem("adminName", admin.name || admin.username);

                document.getElementById("loginBox").style.display = "none";
            
                loadPending();
            };

            async function loadPending() {
                const q = query(
                    collection(db, "requests"),
                    where("status", "==", "pending"),
                    where("requestType", "==", "CONSUMABLE")
                );

                const snap = await getDocs(q);
                allData = [];

                snap.forEach(d => {
                    allData.push({ id: d.id, ...d.data() });
                });
                
                currentPage = 1; // âœ… reset page
                render(allData);
            }


            function render(data) {
                tableBody.innerHTML = "";

                if (!data.length) {
                    tableBody.innerHTML =
                    "<tr><td colspan='7'>No pending requests</td></tr>";
                    document.getElementById("pagination").style.display = "none";
                    return;
                }

                const totalPages = Math.ceil(data.length / PAGE_SIZE);
                if (currentPage > totalPages) currentPage = totalPages;

                const start = (currentPage - 1) * PAGE_SIZE;
                const pageData = data.slice(start, start + PAGE_SIZE);

                pageData.forEach(d => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${d.code}</td>
                        <td>${d.name}</td>
                        <td>${d.qty}</td>
                        <td>${d.createdAt?.split("T")[0] || ""}</td>
                        <td>${d.requestedBy}</td>
                        <td>${d.location}</td>
                        <td>
                            <button class="btn-approve" data-i18n="btn_approve" onclick='approve("${d.id}", ${JSON.stringify(d)})'></button>
                            <button class="btn-reject" data-i18n="btn_reject" onclick='reject("${d.id}")'></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

                // ===== pagination info =====
                document.getElementById("pagination").style.display =
                    totalPages > 1 ? "block" : "none";

                document.getElementById("pageInfo").innerText =
                    `Page ${currentPage} / ${totalPages}`;

                setLanguage(localStorage.getItem("lang") || "en", false);
            }


            function applyFilter() {
                const c = filterCode.value.toLowerCase();
                const n = filterName.value.toLowerCase();
                const b = filterBy.value.toLowerCase();

                const filtered = allData.filter(d =>
                    (!c || d.code.toLowerCase().includes(c)) &&
                    (!n || d.name.toLowerCase().includes(n)) &&
                    (!b || d.requestedBy.toLowerCase().includes(b))
                );

                currentPage = 1; // âœ… reset page
                render(filtered);
            }


            filterCode.addEventListener("input", applyFilter);
            filterName.addEventListener("input", applyFilter);
            filterBy.addEventListener("input", applyFilter);

            window.approve = async (requestId, req) => {
                if (!checkAdminSession()) return;

                // 1ï¸âƒ£ Ghi ledger kho
                await addDoc(collection(db, "consumables"), {
                    code: req.code,
                    name: req.name,

                    qty: req.type === "EXPORT" ? -Number(req.qty): Number(req.qty),

                    type: req.type,               // IMPORT | EXPORT
                    location: req.location,       // ðŸ“ vá»‹ trÃ­ kho

                    // ðŸ‘‰ ngÆ°á»i chá»‹u trÃ¡ch nhiá»‡m kho (admin)
                    actionBy: localStorage.getItem("adminLogin"),
                    actionAt: getVNDateString(),

                    // ðŸ‘‰ trace ngÆ°á»£c láº¡i request
                    requestedBy: req.requestedBy,
                    requestedAt: req.createdAt,

                    refRequestId: requestId
                });


                // 2ï¸âƒ£ Update request
                await updateDoc(doc(db, "requests", requestId), {
                    status: "approved",
                    approvedBy: localStorage.getItem("adminLogin"),
                    approvedAt: getVNDateString()
                });

                loadPending();
            };


            window.reject = async id => {
                if (!checkAdminSession()) return;

                if (!confirm("Reject this request?")) return;

                await updateDoc(doc(db, "requests", id), {
                    status: "rejected",
                    rejectedBy: localStorage.getItem("adminLogin"),
                    rejectedAt: getVNDateString()
                });

                loadPending();
            };

            window.nextPage = function () {
                const totalPages = Math.ceil(allData.length / PAGE_SIZE);
                if (currentPage < totalPages) {
                    currentPage++;
                    render(allData);
                }
            };

            window.prevPage = function () {
                if (currentPage > 1) {
                    currentPage--;
                    render(allData);
                }
            };



            loadPending();
        </script>

        <script>
            /* ===== TRANSLATIONS ===== */
            const translations = {
                en: {
                    btn_approve: "Approve",
                    btn_reject: "Reject",
                    back_btn:"Back",
                    logout_btn:"Logout",
                    th_code: "Code",
                    th_name: "Name",
                    th_qty: "Qty",
                    th_date: "Date",
                    th_by: "Request By",
                    th_location: "Location",
                    th_action: "Action",
                },
                zh: {
                    btn_approve: "æ ¸å‡†",
                    btn_reject: "é§å›ž",
                    back_btn:"è¿”å›ž",
                    logout_btn:"ç™»å‡º",
                    th_code: "ç‰©æ–™ç·¨è™Ÿ",
                    th_name: "ç‰©æ–™åç¨±",
                    th_qty: "æ•¸é‡",
                    th_date: "æ—¥æœŸ",
                    th_by: "ç”³è«‹äººå“¡",
                    th_location: "å­˜æ”¾ä½ç½®",
                    th_action: "æ“ä½œ",
                }
            };


            /* ===== CORE LANGUAGE ===== */
            function setLanguage(lang, save = true) {
                if (save) {
                    localStorage.setItem("lang", lang);
                }

                document.querySelectorAll("[data-i18n]").forEach(el => {
                    const key = el.dataset.i18n;
                    el.innerText = translations[lang][key] || "";
                });

                /* PLACEHOLDER */
                document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
                    const key = el.dataset.i18nPlaceholder;
                    el.placeholder = translations[lang][key] || "";
                });
            }

            function initLanguage() {
                const savedLang = localStorage.getItem("lang") || "en";

                setLanguage(savedLang, false);

                const toggle = document.getElementById("langToggle");
                toggle.checked = savedLang === "zh";

                toggle.addEventListener("change", e => {
                    setLanguage(e.target.checked ? "zh" : "en");
                });
            }

            function getVNDateString() {
                // const now = new Date();
                const parts = new Intl.DateTimeFormat("en-CA", {
                timeZone: "Asia/Ho_Chi_Minh",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
              }).formatToParts(new Date());

              const get = t => parts.find(p => p.type === t).value;

              return `${get("year")}/${get("month")}/${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
            }


            function getTodayVN() {
                const now = new Date();
                const vn = new Date(now.getTime() + 7 * 60 * 60 * 1000);

                const y = vn.getUTCFullYear();
                const m = String(vn.getUTCMonth() + 1).padStart(2, "0");
                const d = String(vn.getUTCDate()).padStart(2, "0");

                return `${y}-${m}-${d}`;
            }

            /* ===== INIT ===== */
            document.addEventListener("DOMContentLoaded", () => {
                initLanguage();

                if (!checkAdminSession()) return;

                loadPending();
            });

            function logout() {
                localStorage.removeItem("adminLogin");
                localStorage.removeItem("adminName");
                localStorage.removeItem("adminExpire");

                window.location.href = "login.html";
            }


            function checkAdminSession() {
                const admin = localStorage.getItem("adminLogin");
                const expire = localStorage.getItem("adminExpire");

                if (!admin || !expire) {
                    window.location.href = "login.html";
                    return false;
                }

                if (Date.now() > Number(expire)) {
                    alert("Session expired. Please login again.");
                    logout();
                    return false;
                }

                return true;
            }
        </script>
    </body>
</html>
