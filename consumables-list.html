<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Consumables Inventory</title>

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding-top: 80px;
                background-color: #f4f4f4;
                text-align: center;
            }

            /* ===== BANNER ===== */
            .banner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: #4273c3;
                color: white;
                font-size: 20px;
                font-weight: bold;
                padding: 15px 20px;
                z-index: 1000;
                border-bottom-left-radius: 20px;
                border-bottom-right-radius: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                text-align: left;
            }

            .credit {
                font-size: 12px;
                font-weight: normal;
                color: #ddd;
                margin-top: 5px;
            }

            h2 {
                margin-bottom: 25px;
                color: #333;
                min-height: 40px; /* MATCH STANDARD */
            }

            /* ===== TABLE ===== */
            .table-container {
                max-width: 1000px;
                margin: auto;
                background: white;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* ‚≠ê CH·ªêT */
            }

            th,
            td {
                padding: 10px 12px;
                border-bottom: 1px solid #ddd;
                text-align: left;
                font-size: 14px;
            }

            th {
                background-color: #f0f4ff;
                color: #333;
                height: 46px; /* ‚≠ê KH√ìA CHI·ªÄU CAO */
                vertical-align: middle;
                white-space: nowrap; /* ‚≠ê KH√îNG WRAP */
            }

            tr:hover {
                background-color: #f9f9f9;
            }

            .actions {
                text-align: center;
                margin-top: 20px;
            }

            button {
                padding: 10px 18px;
                border-radius: 20px;
                border: 2px solid #007bff;
                background: white;
                cursor: pointer;
                font-weight: bold;
            }

            button:hover {
                background: #007bff;
                color: white;
            }

            /* ===== REQUEST TYPE SWITCH ===== */
            .type-switch {
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-bottom: 15px;
            }

            .type-switch button {
                padding: 8px 20px;
                border-radius: 20px;
                border: 2px solid #007bff;
                background: white;
                font-weight: bold;
                cursor: pointer;
            }

            .type-switch button.active {
                background: #007bff;
                color: white;
            }

            .type-switch button.inactive {
                border-color: #ccc;
                color: #999;
                background: #f3f3f3;
            }

            .type-switch button.inactive:hover {
                background: #f3f3f3;
                color: #999;
                cursor: pointer;
            }

            /* ===== LANGUAGE SWITCH ===== */
            .lang-switch {
                position: fixed;
                top: 15px;
                right: 20px;
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 2000;
                font-weight: bold;
                color: white;
            }

            .switch {
                position: relative;
                display: block;
                width: 46px;
                height: 24px;
                flex-shrink: 0;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                inset: 0;
                background-color: #ccc;
                border-radius: 34px;
                transition: 0.3s;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                border-radius: 50%;
                transition: 0.3s;
            }

            input:checked + .slider {
                background-color: #007bff;
            }

            input:checked + .slider:before {
                transform: translateX(22px);
            }

            .filter-bar {
                display: flex;
                gap: 12px;
                margin-bottom: 15px;
            }

            .filter-bar input {
                flex: 1;
                padding: 8px 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 14px;
            }

            th:nth-child(1),td:nth-child(1) {width: 15%;}
            th:nth-child(2),td:nth-child(2) {width: 15%;}
            th:nth-child(3),td:nth-child(3) {width: 10%;text-align: center;}
            th:nth-child(4),td:nth-child(4) {width: 15%;}
            th:nth-child(5),td:nth-child(5) {width: 15%;}
            th:nth-child(6),td:nth-child(6) {width: 15%;}
            th:nth-child(7),td:nth-child(7) {width: 10%;}
            th:nth-child(8),td:nth-child(8) {width: 5%;}

            /* ===== MOBILE ===== */
            @media (max-width: 480px) {
                body {
                    padding-top: 70px;
                }

                .banner {
                    font-size: 16px;
                    padding: 10px 15px;
                    border-radius: 0;
                }

                .controls {
                    flex-direction: column;
                    align-items: center;
                    gap: 30px;
                }

                button,
                .placeholder {
                    width: 90%;
                    max-width: 320px;
                }
            }
        </style>
    </head>

    <body>
        <div class="banner">
            Inventory Management System
            <div class="credit">
                &copy; Steven Lee - Email: leechunju1608@gmail.com
            </div>

            <div class="lang-switch">
                <span>EN</span>
                <label class="switch">
                    <input type="checkbox" id="langToggle" />
                    <span class="slider"></span>
                </label>
                <span>‰∏≠</span>
            </div>
        </div>

        <h2 data-i18n="title"></h2>

        <div class="type-switch">
            <button id="btnConsumable" data-i18n="btn_consumable" class="active"></button>
            <button id="btnTool" data-i18n="btn_tool" class="inactive"></button>
        </div>

        <div class="table-container">
            <div class="filter-bar">
                <input
                    type="text"
                    id="filterCode"
                    data-i18n-placeholder="th_code"
                />
                <input
                    type="text"
                    id="filterName"
                    data-i18n-placeholder="th_name"
                />
                <input
                    type="text"
                    id="filterBy"
                    data-i18n-placeholder="th_by"
                />
            </div>

            <table>
                <thead>
                    <tr>
                        <th data-i18n="th_code"></th>
                        <th data-i18n="th_name"></th>
                        <th data-i18n="th_qty"></th>
                        <th data-i18n="th_type"></th>
                        <th data-i18n="th_date"></th>
                        <th data-i18n="th_by"></th>
                        <th data-i18n="th_location"></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8">Loading...</td>
                    </tr>
                </tbody>
            </table>

            <div id="pagination" style="margin-top:15px;text-align:center;">
                <button onclick="prevPage()">‚óÄ Prev</button>
                <span id="pageInfo" style="margin:0 10px;"></span>
                <button onclick="nextPage()">Next ‚ñ∂</button>
            </div>
        </div>


        <div class="actions">
            <button
                onclick="location.href='index_admin.html'"
                data-i18n="back"
            ></button>
        </div>

        <!-- ===== FIREBASE ===== -->
        <script>
            const translations = {
                en: {
                    title: "Inventory",
                    th_code: "Item Code",
                    th_name: "Item Name",
                    th_qty: "Quantity",
                    th_type: "Last Action Type",
                    th_date: "Last Action Date",
                    th_by: "Last Action By",
                    // cf_by: "Confirmed By",
                    th_location: "Location",
                    back:"Back",
                    btn_consumable: "Consumable",
                    btn_tool: "Tool",
                },
                zh: {
                    title: "Â∫´Â≠ò",
                    th_code: "Áâ©ÊñôÁ∑®Ëôü",
                    th_name: "Áâ©ÊñôÂêçÁ®±",
                    th_qty: "Êï∏Èáè",
                    th_type: "ÊúÄÂæåÂãï‰Ωú",
                    th_date: "ÊúÄÂæåÊõ¥Êñ∞Êó•Êúü",
                    th_by: "ÊúÄÂæåÊìç‰Ωú‰∫∫Âì°",
                    // cf_by: "Á¢∫Ë™ç‰∫∫Âì°",
                    th_location: "Â≠òÊîæ‰ΩçÁΩÆ",
                    back:"ËøîÂõû",
                    btn_consumable: "ËÄóÊùê",
                    btn_tool: "Â∑•ÂÖ∑",
                }
            };

            /* ===== LANGUAGE CORE ===== */
            function setLanguage(lang, save = true) {
                if (save) {
                    localStorage.setItem("lang", lang);
                }

                document.querySelectorAll("[data-i18n]").forEach(el => {
                    const key = el.dataset.i18n;
                    el.innerText = translations[lang][key] || "";
                });

                /* PLACEHOLDER */
                document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
                    const key = el.dataset.i18nPlaceholder;
                    el.placeholder = translations[lang][key] || "";
                });
            }

            function initLanguage() {
                const savedLang = localStorage.getItem("lang") || "en";
                setLanguage(savedLang, false);

                const toggle = document.getElementById("langToggle");
                toggle.checked = savedLang === "zh";

                toggle.addEventListener("change", e => {
                    setLanguage(e.target.checked ? "zh" : "en");
                });
            }

            /* ===== INIT ===== */
            document.addEventListener("DOMContentLoaded", () => {
                initLanguage();
                setActiveTypeButton();
                loadInventory();
            });
        </script>

        <script type="module">
            let currentItemType = "CONSUMABLE"; // m·∫∑c ƒë·ªãnh
            const btnConsumable = document.getElementById("btnConsumable");
            const btnTool = document.getElementById("btnTool");


            // "en" | "zh"
            const i18n = {
                en: {
                    moveTitle: (code, name) =>
                        `Move "${code} - ${name}"`,
                    currentLoc: loc =>
                        `Current: ${loc}\nNew location:`,
                    qtyPrompt: qty =>
                        `Available qty: ${qty}\nEnter qty to move:`,
                    invalidQty: "‚ùå Invalid quantity",
                    confirmMove: (moveQty, totalQty, code, name, from, to) =>
                        `Confirm move ${moveQty} / ${totalQty}\n` +
                        `"${code} - ${name}"\n` +
                        `From: ${from}\nTo: ${to}`,
                    success: "‚úÖ Location updated",
                    noteTo: (qty, loc) => `Move ${qty} to ${loc}`,
                    noteFrom: (qty, loc) => `Move ${qty} from ${loc}`
                },

                zh: {
                    moveTitle: (code, name) =>
                        `ÁßªÂãï„Äå${code} - ${name}„Äç`,
                    currentLoc: loc =>
                        `ÁõÆÂâç‰ΩçÁΩÆÔºö${loc}\nÊñ∞‰ΩçÁΩÆÔºö`,
                    qtyPrompt: qty =>
                        `ÂèØÁî®Êï∏ÈáèÔºö${qty}\nË´ãËº∏ÂÖ•ÁßªÂãïÊï∏ÈáèÔºö`,
                    invalidQty: "‚ùå Êï∏Èáè‰∏çÊ≠£Á¢∫",
                    confirmMove: (moveQty, totalQty, code, name, from, to) =>
                        `Á¢∫Ë™çÁßªÂãï ${moveQty} / ${totalQty}\n` +
                        `„Äå${code} - ${name}„Äç\n` +
                        `ÂæûÔºö${from}\nÂà∞Ôºö${to}`,
                    success: "‚úÖ ‰ΩçÁΩÆÂ∑≤Êõ¥Êñ∞",
                    noteTo: (qty, loc) => `ÁßªÂãï ${qty} Âà∞ ${loc}`,
                    noteFrom: (qty, loc) => `Âæû ${loc} ÁßªÂãï ${qty}`
                }
            };

            let allItems = [];
            let currentPage = 1;
            const PAGE_SIZE = 5;
            let filteredItems = [];

            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
            import { getFirestore, collection, getDocs, query, orderBy, where, addDoc}
                from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyA7zpEseZx9x_hiPcRHtp4h-All7CL-Dog",
                authDomain: "atbs-inventory.firebaseapp.com",
                projectId: "atbs-inventory",
                storageBucket: "atbs-inventory.firebasestorage.app",
                messagingSenderId: "196392830940",
                appId: "1:196392830940:web:e49a096fb56ac6a58cf119"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const tableBody = document.getElementById("tableBody");

            const filterCode = document.getElementById("filterCode");
            const filterName = document.getElementById("filterName");
            const filterBy   = document.getElementById("filterBy");

            /* ===== LOAD DATA ===== */
            async function loadInventory() {
                tableBody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

                try {
                    const collectionName = currentItemType === "TOOL" ? "tools" : "consumables";

                    const q = query(collection(db, collectionName));
                    const snapshot = await getDocs(q);

                    const stockMap = {};

                    snapshot.forEach(doc => {
                        const d = doc.data();

                        // üëá key t·ªìn kho = code + name + location
                        const key = `${d.code}||${d.name}||${d.location || ""}`;

                        if (!stockMap[key]) {
                            stockMap[key] = {
                                code: d.code,
                                name: d.name,
                                qty: 0,

                                type: "",
                                lastActionAt: "",
                                lastActionBy: "",
                                location: d.location || "",
                                lastAction: d.type || ""
                            };
                        }

                        stockMap[key].qty += Number(d.qty) || 0;

                        // üëá l·∫•y h√†nh ƒë·ªông m·ªõi nh·∫•t (GI·ªÆ NGUY√äN FIELD)
                        if (
                            !stockMap[key].lastActionAt ||
                            d.actionAt > stockMap[key].lastActionAt
                        ) {
                            stockMap[key].lastActionAt = d.requestedAt;
                            stockMap[key].lastActionBy = d.requestedBy;
                            stockMap[key].lastAction = d.type;
                        }
                    });

                    allItems = Object.values(stockMap)
                        .filter(i => i.qty !== 0); // ch·ªâ hi·ªán c√≤n t·ªìn

                    filteredItems = allItems;
                    currentPage = 1;
                    renderTable(filteredItems);

                } catch (e) {
                    console.error(e);
                    tableBody.innerHTML =
                        "<tr><td colspan='8'>Load failed</td></tr>";
                }
            }


            /* ===== RENDER ===== */
            function renderTable(data) {
                tableBody.innerHTML = "";
                const isAdmin = !!localStorage.getItem("adminLogin");

                if (!data.length) {
                    tableBody.innerHTML =
                        "<tr><td colspan='8'>No stock</td></tr>";
                    document.getElementById("pagination").style.display = "none";
                    return;
                }

                const totalPages = Math.ceil(data.length / PAGE_SIZE);
                if (currentPage > totalPages) currentPage = totalPages;

                const start = (currentPage - 1) * PAGE_SIZE;
                const pageData = data.slice(start, start + PAGE_SIZE);

                pageData.forEach(d => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${d.code}</td>
                        <td>${d.name}</td>
                        <td>${d.qty}</td>
                        <td>${d.lastAction}</td>
                        <td>${d.lastActionAt || ""}</td>
                        <td>${d.lastActionBy || ""}</td>
                        <td>${d.location}</td>
                        <td>${isAdmin ? `<span style="cursor:pointer;margin-left:6px;"onclick='changeLocation(${JSON.stringify(d)})'>‚úèÔ∏è</span>` : ""}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                document.getElementById("pagination").style.display =
                    totalPages > 1 ? "block" : "none";

                document.getElementById("pageInfo").innerText =
                    `Page ${currentPage} / ${totalPages}`;
            }


            /* ===== FILTER ===== */
            function applyFilter() {
                const codeVal = filterCode.value.toLowerCase();
                const nameVal = filterName.value.toLowerCase();
                const byVal   = filterBy.value.toLowerCase();

                filteredItems = allItems.filter(d => {
                    return (
                        (!codeVal || d.code.toLowerCase().includes(codeVal)) &&
                        (!nameVal || d.name.toLowerCase().includes(nameVal)) &&
                        (!byVal   || (d.lastActionBy || "").toLowerCase().includes(byVal))
                    );
                });

                currentPage = 1;
                renderTable(filteredItems );
            }


            /* ===== EVENTS ===== */
            filterCode.addEventListener("input", applyFilter);
            filterName.addEventListener("input", applyFilter);
            filterBy.addEventListener("input", applyFilter);

            window.changeLocation = async function (item) {

                const lang = localStorage.getItem("lang") || "en";
                const t = i18n[lang];

                // Input new Location
                const newLoc = prompt(
                    `${t.moveTitle(item.code, item.name)}\n` +
                    t.currentLoc(item.location),
                    item.location
                );

                if (!newLoc || newLoc === item.location) return;

                // Input Qty
                const qtyInput = prompt(
                    t.qtyPrompt(item.qty),
                    item.qty
                );

                const moveQty = Number(qtyInput);

                // Validate Qty
                if (
                    !Number.isFinite(moveQty) ||
                    moveQty <= 0 ||
                    moveQty > item.qty
                ) {
                    alert(t.invalidQty);
                    return;
                }

                // Confirm
                if (!confirm(
                    t.confirmMove(
                        moveQty,
                        item.qty,
                        item.code,
                        item.name,
                        item.location,
                        newLoc
                    )
                )) return;

                const admin = localStorage.getItem("adminLogin");
                const targetCollection = currentItemType === "TOOL" ? "tools" : "consumables";

                // 5Ô∏è‚É£ Tr·ª´ kho c≈©
                await addDoc(collection(db, targetCollection), {
                    code: item.code,
                    name: item.name,
                    qty: -Math.abs(moveQty),
                    type: "MOVE_OUT",
                    location: item.location,
                    
                    actionBy: admin,
                    actionAt: getVNDateString(),
                    
                    requestedBy: admin,
                    requestedAt: getVNDateString(),

                    note: t.noteTo(moveQty, newLoc)
                });

                // 6Ô∏è‚É£ C·ªông kho m·ªõi
                await addDoc(collection(db, targetCollection), {
                    code: item.code,
                    name: item.name,
                    qty: Math.abs(moveQty),
                    type: "MOVE_IN",
                    location: newLoc,
                    
                    actionBy: admin,
                    actionAt: getVNDateString(),
                    
                    requestedBy: admin,
                    requestedAt: getVNDateString(),

                    note: t.noteFrom(moveQty, item.location)
                });

                alert(t.success);
                loadInventory();
            };


            function getVNDateString() {
                // const now = new Date();
                const parts = new Intl.DateTimeFormat("en-CA", {
                timeZone: "Asia/Ho_Chi_Minh",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
              }).formatToParts(new Date());

              const get = t => parts.find(p => p.type === t).value;

              return `${get("year")}/${get("month")}/${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
            }
            

            function getTodayVN() {
                const now = new Date();
                const vn = new Date(now.getTime() + 7 * 60 * 60 * 1000);

                const y = vn.getUTCFullYear();
                const m = String(vn.getUTCMonth() + 1).padStart(2, "0");
                const d = String(vn.getUTCDate()).padStart(2, "0");

                return `${y}-${m}-${d}`;
            }

            window.nextPage = function () {
                const totalPages = Math.ceil(filteredItems.length / PAGE_SIZE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable(filteredItems);
                }
            };

            window.prevPage = function () {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable(filteredItems);
                }
            };

            document.getElementById("btnConsumable").addEventListener("click", () => {
                if (currentItemType === "CONSUMABLE") return;

                currentItemType = "CONSUMABLE";
                setActiveTypeButton();
                loadInventory();
            });

            document.getElementById("btnTool").addEventListener("click", () => {
                if (currentItemType === "TOOL") return;

                currentItemType = "TOOL";
                setActiveTypeButton();
                loadInventory();
            });

            function setActiveTypeButton() {
                const isConsumable = currentItemType === "CONSUMABLE";

                btnConsumable.classList.toggle("active", isConsumable);
                btnConsumable.classList.toggle("inactive", !isConsumable);

                btnTool.classList.toggle("active", !isConsumable);
                btnTool.classList.toggle("inactive", isConsumable);
            }


            loadInventory();
        </script>
    </body>
</html>
